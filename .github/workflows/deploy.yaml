name: Deploy Frontend to AWS Amplify

on:
  push:
    branches: [main, develop]
  workflow_dispatch:

env:
  NODE_VERSION: '18'

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: Install dependencies
        run: npm install
        
      - name: Set environment variables
        run: |
          if [ "${{ github.ref_name }}" = "main" ]; then
            echo "ENVIRONMENT=production" >> $GITHUB_ENV
            echo "API_ENDPOINT=${{ secrets.REACT_APP_API_ENDPOINT }}" >> $GITHUB_ENV
            echo "AMPLIFY_BRANCH=main" >> $GITHUB_ENV
            ENV_NAME="production"
            API_URL="${{ secrets.REACT_APP_API_ENDPOINT }}"
          elif [ "${{ github.ref_name }}" = "develop" ]; then
            echo "ENVIRONMENT=development" >> $GITHUB_ENV
            echo "API_ENDPOINT=${{ secrets.REACT_APP_API_DEV_ENDPOINT }}" >> $GITHUB_ENV
            echo "AMPLIFY_BRANCH=develop" >> $GITHUB_ENV
            ENV_NAME="development"
            API_URL="${{ secrets.REACT_APP_API_DEV_ENDPOINT }}"
          else
            echo "ENVIRONMENT=staging" >> $GITHUB_ENV
            echo "API_ENDPOINT=${{ secrets.REACT_APP_API_DEV_ENDPOINT }}" >> $GITHUB_ENV
            echo "AMPLIFY_BRANCH=develop" >> $GITHUB_ENV
            ENV_NAME="staging"
            API_URL="${{ secrets.REACT_APP_API_DEV_ENDPOINT }}"
          fi
          echo "Deploying to $ENV_NAME environment"
          echo "Using API endpoint: $API_URL"
          
      - name: Create environment file
        run: |
          echo "Creating ${{ env.ENVIRONMENT }} environment file..."
          cat > .env.production << EOF
          # AWS Cognito Configuration
          REACT_APP_COGNITO_USER_POOL_ID=${{ secrets.REACT_APP_COGNITO_USER_POOL_ID }}
          REACT_APP_COGNITO_USER_POOL_CLIENT_ID=${{ secrets.REACT_APP_COGNITO_USER_POOL_CLIENT_ID }}
          REACT_APP_COGNITO_DOMAIN=${{ secrets.REACT_APP_COGNITO_DOMAIN }}
          REACT_APP_LOGOUT_URI=${{ secrets.REACT_APP_LOGOUT_URI }}
          
          # API Configuration - Dynamic based on branch
          REACT_APP_API_ENDPOINT=${{ env.API_ENDPOINT }}
          
          # Environment Info
          REACT_APP_ENVIRONMENT=${{ env.ENVIRONMENT }}
          REACT_APP_VERSION=${{ github.sha }}
          
          # AWS Region
          REACT_APP_AWS_REGION=${{ secrets.REACT_APP_AWS_REGION || 'us-east-1' }}
          EOF
          
          echo "Environment variables configured for ${{ env.ENVIRONMENT }} build"
          echo "API Endpoint: ${{ env.API_ENDPOINT }}"
          
      - name: Build application
        run: npm run build
        env:
          CI: false
        
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          role-session-name: GitHubActions-FrontendDeploy
          aws-region: ${{ secrets.REACT_APP_AWS_REGION || 'us-east-1' }}

      - name: Deploy to AWS Amplify (if using Amplify)
        run: |
          # Trigger Amplify deployment for appropriate branch
          aws amplify start-job \
            --app-id ${{ secrets.AMPLIFY_APP_ID }} \
            --branch-name ${{ env.AMPLIFY_BRANCH }} \
            --job-type RELEASE

          echo "Triggered Amplify deployment for branch: ${{ env.AMPLIFY_BRANCH }}"
            
      - name: Output deployment info
        run: |
          echo "ðŸš€ Frontend deployment completed!"
          echo "Branch: ${{ github.ref_name }}"
          echo "Environment: ${{ env.ENVIRONMENT }}"
          echo "API Endpoint: ${{ env.API_ENDPOINT }}"
          echo "Build completed at: $(date)"
          echo "Commit SHA: ${{ github.sha }}"
          
          if [ -n "${{ secrets.AMPLIFY_APP_ID }}" ]; then
            echo "Amplify App ID: ${{ secrets.AMPLIFY_APP_ID }}"
            echo "Amplify Branch: ${{ env.AMPLIFY_BRANCH }}"
          fi